# Supabase Integration

This project stores contact form submissions in Supabase and uses Supabase
Storage for service images.

## Database Schema

Create a `contact_messages` table:

```sql
create table if not exists contact_messages (
  id bigint generated by default as identity primary key,
  name text,
  email text,
  message text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);
```

Enable Row Level Security and allow inserts using the service role key:

```sql
alter table contact_messages enable row level security;
create policy "Allow inserts with service role" on contact_messages
  for insert using (auth.role() = 'service_role');
```

## Environment Variables

These variables must be available at build and runtime:

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `NEXT_PUBLIC_SUPABASE_BUCKET`
- `SUPABASE_SAVE_CONTACT_FUNCTION_URL`

Set them in DigitalOcean App Platform via `.do/app.yaml` and configure matching GitHub secrets so deployment workflows can pass them through.

The `save-contact` Edge Function also requires the following secrets to forward messages to your mailbox:

- `BUSINESS_EMAIL`
- `BUSINESS_EMAIL_APP_PASSWORD`

## Verification

After deploying with the variables configured, test the endpoint:

```bash
curl -X POST "$SITE_URL/api/contact" \\
  -H 'Content-Type: application/json' \\
  -d '{"name":"Test","email":"user@example.com","message":"Hello"}'
```

A `200` response indicates the request was accepted. Check the `contact_messages` table in Supabase to confirm the row was created.

## Storage Bucket

1. In the Supabase dashboard create a **public** bucket, e.g. `service-images`.
2. Upload images to this bucket. Their public URLs are used by the web app.
3. Set the bucket name in `NEXT_PUBLIC_SUPABASE_BUCKET`.
4. To upload images from the site, send a `POST` request with `multipart/form-data` to `/api/images` with the file field named `file`. The endpoint returns the public URL of the uploaded asset.

## Edge Functions

Longer running or database heavy work is handled by Supabase Edge
Functions. The project includes a `save-contact` function that inserts
contact form submissions into the database.

### Local Development

```bash
supabase start
supabase functions serve save-contact
```

### Deploy

```bash
supabase functions deploy save-contact
```

Expose the deployed URL via `SUPABASE_SAVE_CONTACT_FUNCTION_URL` so the
Next.js API route can call it.

## Security

Enable Row Level Security on tables, restrict bucket access, and keep
service role keys private. Refer to the [Supabase docs](https://supabase.com/docs) for details.
